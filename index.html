<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CWH Database - Sort & Filter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #1f2937; --accent: #2563eb; --bg: #f3f4f6; --border-color: #d1d5db; --success: #db2777; --save-color: #059669; --danger: #dc2626; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--bg); margin: 0; padding: 5px; }
        
        .container { background: white; padding: 10px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); width: fit-content; min-width: 100%; margin: auto; }
        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px; }
        h2 { color: var(--primary); font-size: 1.1rem; margin: 0; border-left: 4px solid var(--accent); padding-left: 8px; }
        #saveStatus { font-size: 0.65rem; color: var(--save-color); font-weight: bold; margin-left: 10px; }
        #currentDate { font-size: 0.75rem; color: #4b5563; font-weight: 600; }
        
        .table-wrapper { border-radius: 8px; border: 1px solid var(--border-color); background: white; overflow-x: auto; position: relative; }
        table { width: 100%; border-collapse: collapse; table-layout: auto; }
        
        thead th { background-color: var(--primary); color: #ffffff; text-align: left; padding: 12px 10px; font-size: 0.8rem; font-weight: 600; border-right: 1px solid #374151; white-space: nowrap; cursor: pointer; position: relative; }
        thead th:hover { background-color: #374151; }
        
        /* Sorting Icons */
        .sort-icon:after { content: ' ‚Üï'; font-size: 0.7rem; opacity: 0.5; margin-left: 5px; }
        .sort-asc:after { content: ' ‚Üë'; opacity: 1; color: #10b981; }
        .sort-desc:after { content: ' ‚Üì'; opacity: 1; color: #10b981; }

        td { border: 1px solid var(--border-color); padding: 12px 10px; color: #000000 !important; font-size: 0.85rem; outline: none; font-weight: 700; white-space: nowrap; background-color: #ffffff; }
        .no-col { width: 50px; text-align: center; }
        tbody tr:nth-child(even) td { background-color: #f9fafb; }
        td:focus { background-color: #f0f7ff !important; box-shadow: inset 0 0 0 1.5px var(--accent); }

        .controls { display: flex; gap: 8px; margin-top: 15px; padding: 0 5px; flex-wrap: wrap; }
        .btn { flex: 1; border: none; padding: 12px; border-radius: 8px; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 6px; font-size: 0.8rem; color: white; min-width: 120px; }
        .add-btn { background-color: var(--accent); }
        .png-btn { background-color: var(--success); }
        .clear-btn { background-color: var(--danger); }

        .popup-menu { position: absolute; background: white; border: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 1000; display: none; border-radius: 8px; width: 220px; max-height: 250px; overflow-y: auto; }
        .menu-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6; font-size: 0.85rem; font-weight: 600; color: #1f2937; }
        .menu-item:hover { background-color: #ebf5ff; }
        .filter-header { padding: 8px 12px; background: #f3f4f6; font-size: 0.7rem; color: #6b7280; border-bottom: 1px solid var(--border-color); font-weight: bold; }
    </style>
</head>
<body>

<div id="captureArea" class="container">
    <div class="header-section">
        <div><h2>CWH Database <span id="saveStatus"></span></h2></div>
        <div id="currentDate"></div>
    </div>

    <div class="table-wrapper">
        <table id="mainTable">
            <thead>
                <tr>
                    <th class="no-col" onclick="showAllRows()">No</th>
                    <th style="min-width:80px" class="sort-icon" onclick="sortTable(1, this)">Line</th>
                    <th style="min-width:200px" onclick="showFilter(2, event)">Item ‚ñº</th>
                    <th style="min-width:150px">Location</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div id="customPopup" class="popup-menu"></div>
    </div>

    <div class="controls" data-html2canvas-ignore>
        <button class="btn add-btn" onclick="addFiveRows()">+ Add 5 Rows</button>
        <button class="btn png-btn" onclick="downloadPNG()">üì∏ Save PNG</button>
        <button class="btn clear-btn" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
    </div>
</div>

<script>
    const bulkItems = "MB Qt Ctn,MB Qt Crt,Promo MB Qt Ctn,Promo MB Qt Crt,MB Can 500ml,MB Can 330ml,MB Lager Pint Ctn,MB Lager Pint Crt,Mpre Pint Ctn,Mpre Pint Crt,Mpre Can 330ml,MS Can 330ml,BS Can 330ml,BS Qt Ctn,BS Qt Crt,Promo BS Qt Crt,Promo BS Qt Ctn,AG 6.5% Can 330ml,AG 6.5% Can 500ml,Promo AG 6.5% Can 500ml,AG 5% Can 500ml,AG 5% Can 330ml,AG 8.1% Can 500ml,Keen Can 500ml,Keen Can 330ml,MB 30L,Mpre 10L,Mpre 30L,BS 10L,BS 30L,AG6.5% 30L,AG 5% 30L,Keen 10L,Keen 30L,Promo Keen 500ml";
    const itemsArray = bulkItems.split(",").map(item => item.trim());
    const tbody = document.getElementById('tableBody');
    const popup = document.getElementById('customPopup');
    const saveStatus = document.getElementById('saveStatus');
    let sortDirection = true; // true = Asc, false = Desc

    window.onload = () => {
        const d = new Date();
        document.getElementById('currentDate').innerText = "Date: " + d.getDate() + "/" + (d.getMonth() + 1) + "/" + d.getFullYear();
        loadTable();
    };

    function loadTable() {
        const savedData = localStorage.getItem('cwh_filter_v1');
        const now = new Date().getTime();
        tbody.innerHTML = '';

        if (savedData) {
            const parsed = JSON.parse(savedData);
            if (now - parsed.timestamp > 24 * 60 * 60 * 1000) {
                initTable(20);
            } else {
                parsed.tableData.forEach(d => createRow(d.no, d.line, d.item, d.loc));
            }
        } else {
            initTable(20);
        }
    }

    function initTable(count) {
        tbody.innerHTML = '';
        for (let i = 1; i <= count; i++) createRow(i);
    }

    function createRow(no, line = '', item = '', loc = '') {
        const row = tbody.insertRow();
        row.innerHTML = `<td class="no-col" contenteditable="true">${no}</td><td contenteditable="true">${line}</td><td contenteditable="true" oninput="handleItemInput(this)">${item}</td><td contenteditable="true">${loc}</td>`;
    }

    // Line Column ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ Sorting Function
    function sortTable(colIndex, headerElement) {
        const rows = Array.from(tbody.rows);
        
        rows.sort((a, b) => {
            const valA = a.cells[colIndex].innerText.trim().toLowerCase();
            const valB = b.cells[colIndex].innerText.trim().toLowerCase();
            
            if (!valA && valB) return 1;
            if (valA && !valB) return -1;
            
            return sortDirection 
                ? valA.localeCompare(valB, undefined, {numeric: true, sensitivity: 'base'})
                : valB.localeCompare(valA, undefined, {numeric: true, sensitivity: 'base'});
        });

        // UI Updates
        document.querySelectorAll('th').forEach(th => th.classList.remove('sort-asc', 'sort-desc'));
        headerElement.classList.add(sortDirection ? 'sort-asc' : 'sort-desc');

        rows.forEach(row => tbody.appendChild(row));
        sortDirection = !sortDirection;
        autoSave();
    }

    function showFilter(colIndex, event) {
        event.stopPropagation();
        const rows = Array.from(tbody.rows);
        const uniqueValues = [...new Set(rows.map(r => r.cells[colIndex].innerText.trim()))].filter(v => v !== "");
        
        if (uniqueValues.length === 0) return;

        popup.innerHTML = '<div class="filter-header">Filter by:</div>';
        uniqueValues.forEach(val => {
            const div = document.createElement('div');
            div.className = 'menu-item';
            div.innerText = val;
            div.onclick = () => {
                rows.forEach(r => r.style.display = r.cells[colIndex].innerText.trim() === val ? "" : "none");
                popup.style.display = 'none';
            };
            popup.appendChild(div);
        });

        const rect = event.currentTarget.getBoundingClientRect();
        popup.style.left = rect.left + 'px';
        popup.style.top = (rect.bottom + window.scrollY) + 'px';
        popup.style.display = 'block';
    }

    function showAllRows() {
        Array.from(tbody.rows).forEach(r => r.style.display = "");
    }

    function autoSave() {
        const rows = Array.from(tbody.rows);
        const data = rows.map(r => ({ no: r.cells[0].innerText, line: r.cells[1].innerText, item: r.cells[2].innerText, loc: r.cells[3].innerText }));
        localStorage.setItem('cwh_filter_v1', JSON.stringify({ timestamp: new Date().getTime(), tableData: data }));
        saveStatus.innerText = "‚óè Saved " + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        setTimeout(() => saveStatus.innerText = "", 2000);
    }
    setInterval(autoSave, 10000);

    function handleItemInput(cell) {
        const val = cell.innerText.trim().toLowerCase();
        if (!val) { popup.style.display='none'; return; }
        const matches = itemsArray.filter(i => i.toLowerCase().includes(val));
        if (matches.length > 0) {
            popup.innerHTML = '<div class="filter-header">Suggestions:</div>';
            matches.forEach(m => {
                const div = document.createElement('div');
                div.className = 'menu-item'; div.innerText = m;
                div.onclick = () => { cell.innerText = m; popup.style.display='none'; autoSave(); };
                popup.appendChild(div);
            });
            const rect = cell.getBoundingClientRect();
            popup.style.left = rect.left + 'px';
            popup.style.top = (rect.bottom + window.scrollY) + 'px';
            popup.style.display = 'block';
        } else popup.style.display='none';
    }

    function addFiveRows() {
        const currentCount = tbody.rows.length;
        for (let i = 1; i <= 5; i++) createRow(currentCount + i);
        autoSave();
    }

    function clearAllData() {
        if (confirm("Are you sure you want to delete all data?")) {
            localStorage.removeItem('cwh_filter_v1');
            initTable(20);
            saveStatus.innerText = "‚óè Cleared";
            setTimeout(() => saveStatus.innerText = "", 2000);
        }
    }

    function downloadPNG() {
        const rows = Array.from(tbody.rows);
        const original = rows.map(r => r.style.display);
        // ·ÄÖ·Ä¨·Äô·Äõ·Äæ·Ä≠·Äê·Ä≤·Ä∑ row ·Äê·ÄΩ·Ä±·ÄÄ·Ä≠·ÄØ ·ÄÅ·Äè·Äñ·Äª·Ä±·Ä¨·ÄÄ·Ä∫·Äë·Ä¨·Ä∏·Äô·Äö·Ä∫
        rows.forEach(r => { if (r.cells[1].innerText.trim() === "" && r.cells[2].innerText.trim() === "") r.style.display = 'none'; });
        
        html2canvas(document.getElementById("captureArea"), { scale: 3 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `CWH_${new Date().toISOString().slice(0,10)}.png`;
            link.href = canvas.toDataURL();
            link.click();
            // ·Äô·Ä∞·Äú·Ä°·Äê·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏ ·Äï·Äº·Äî·Ä∫·Äñ·Ä±·Ä¨·Ä∫·Äô·Äö·Ä∫
            rows.forEach((r, i) => r.style.display = original[i]);
        });
    }

    document.addEventListener('click', () => popup.style.display = 'none');
</script>
</body>
</html>
